import * as vscode from 'vscode';
import * as dotenv from 'dotenv';
dotenv.config();

import { ingestSignal, RawSignal } from '../backend/processing/signal_extractor';
import { logger } from '../backend/utils/logger';
import { getSlackMCPFunctions } from './mcp_helper';

// Import MCP Slack functions (available when Slack MCP is enabled)
// These are provided by Cursor's MCP system
declare const mcp_Slack_slack_list_channels: (params: { limit?: number; cursor?: string; exclude_archived?: boolean; types?: string[] }) => Promise<any>;
declare const mcp_Slack_slack_get_channel_history: (params: { channel_id: string; limit?: number }) => Promise<any>;
declare const mcp_Slack_slack_search_messages: (params: { query: string; channel_names?: string[]; count?: number }) => Promise<any>;

/**
 * Slack MCP Commands for Cursor Extension
 * These commands use Cursor's built-in Slack MCP to ingest messages
 */

/**
 * Note: Slack MCP functions are available via Cursor's MCP API
 * These functions will be called directly using the MCP function names
 * The actual implementation uses the MCP functions available in Cursor's context
 */

/**
 * Registers Slack MCP commands
 */
export function registerSlackMCPCommands(context: vscode.ExtensionContext) {
  // Command: Ingest Slack Channel
  const ingestChannelCommand = vscode.commands.registerCommand(
    'pm-intelligence.ingestSlackChannel',
    async () => {
      try {
        // Get channel name
        const channelName = await vscode.window.showInputBox({
          prompt: 'Slack channel name (e.g., support, product, or #support)',
          placeHolder: 'support'
        });
        
        if (!channelName) return;

        // Get limit
        const limitStr = await vscode.window.showInputBox({
          prompt: 'Number of messages to ingest [1000]',
          placeHolder: '1000'
        });
        const limit = parseInt(limitStr || '1000') || 1000;

        // Show progress
        await vscode.window.withProgress(
          {
            location: vscode.ProgressLocation.Notification,
            title: `Ingesting Slack messages from #${channelName}`,
            cancellable: false
          },
          async (progress) => {
            progress.report({ increment: 0, message: 'Listing Slack channels...' });

            // Use Cursor's MCP Slack functions
            logger.info('Starting Slack channel ingestion', { channelName, limit });
            progress.report({ increment: 10, message: 'Connecting to Slack MCP...' });
            
            // Get Slack MCP functions
            const slackMCP = await getSlackMCPFunctions();
            logger.info('Slack MCP functions accessed', { 
              hasListChannels: !!slackMCP.listChannels,
              hasGetHistory: !!slackMCP.getChannelHistory
            });
            
            progress.report({ increment: 20, message: 'Listing channels...' });
            
            // List channels
            const channelsResponse = await slackMCP.listChannels({ 
              limit: 200,
              exclude_archived: true 
            });
            
            if (!channelsResponse || !channelsResponse.channels) {
              logger.error('Invalid channels response', { response: channelsResponse });
              throw new Error('Could not retrieve Slack channels. Check Slack MCP configuration.');
            }

            const channels = channelsResponse.channels || channelsResponse;
            logger.info('Retrieved Slack channels', { channelCount: Array.isArray(channels) ? channels.length : 0 });
            
            const channel = channels.find((c: any) => 
              c.name === channelName.replace('#', '') || 
              c.id === channelName
            );

            if (!channel) {
              const availableChannels = channels.map((c: any) => c.name).slice(0, 10).join(', ');
              logger.warn('Channel not found', { channelName, availableChannels });
              throw new Error(`Channel '${channelName}' not found. Available channels: ${availableChannels}`);
            }

            logger.info('Found target channel', { 
              channelName: channel.name, 
              channelId: channel.id 
            });

            progress.report({ increment: 30, message: `Fetching messages from #${channel.name}...` });

            // Get channel history
            progress.report({ increment: 40, message: `Fetching messages from #${channel.name}...` });
            
            logger.info('Fetching channel history', { 
              channelId: channel.id,
              channelName: channel.name,
              limit 
            });
            
            const history = await slackMCP.getChannelHistory({
              channel_id: channel.id,
              limit: limit
            });

            if (!history || (!history.messages && !Array.isArray(history))) {
              logger.error('Invalid history response', { 
                history,
                channelId: channel.id 
              });
              throw new Error('Could not fetch channel history. Check Slack MCP permissions.');
            }

            const messages = history.messages || history;
            logger.info('Retrieved channel messages', { 
              channelName: channel.name,
              messageCount: Array.isArray(messages) ? messages.length : 0 
            });

            logger.info('Retrieved channel messages', { 
              channelName: channel.name,
              messageCount: history.messages?.length || 0 
            });

            progress.report({ increment: 50, message: 'Ingesting signals...' });
            
            let ingestedCount = 0;
            let skippedCount = 0;
            
            for (const message of messages) {
              // Skip bot messages and system messages
              if (message.subtype || message.bot_id) {
                skippedCount++;
                continue;
              }

              const signal: RawSignal = {
                source: 'slack',
                id: message.ts || message.event_ts || Date.now().toString(),
                type: 'message',
                text: message.text || '',
                metadata: {
                  channel: channel.name,
                  channel_id: channel.id,
                  user: message.user,
                  timestamp: message.ts,
                  thread_ts: message.thread_ts
                }
              };

              try {
                await ingestSignal(signal);
                ingestedCount++;
                logger.debug('Message ingested', { 
                  messageTs: message.ts,
                  channel: channel.name 
                });
              } catch (error: any) {
                logger.warn('Failed to ingest message', { 
                  error: error.message,
                  messageTs: message.ts 
                });
              }
            }

            progress.report({ increment: 100, message: 'Complete' });
            
            logger.info('Slack channel ingestion complete', {
              channelName: channel.name,
              ingestedCount,
              skippedCount,
              totalMessages: history.messages?.length || 0
            });
            
            vscode.window.showInformationMessage(
              `✅ Ingested ${ingestedCount} signals from #${channel.name} (${skippedCount} skipped)`
            );
          }
        );
      } catch (error: any) {
        const errorMessage = error?.message || String(error);
        vscode.window.showErrorMessage(`Failed to ingest Slack channel: ${errorMessage}`);
        console.error('Ingest Slack channel error:', error);
      }
    }
  );

  // Command: Ingest Slack Mentions
  const ingestMentionsCommand = vscode.commands.registerCommand(
    'pm-intelligence.ingestSlackMentions',
    async () => {
      try {
        const limitStr = await vscode.window.showInputBox({
          prompt: 'Number of mentions to ingest [50]',
          placeHolder: '50'
        });
        const limit = parseInt(limitStr || '50') || 50;

        await vscode.window.withProgress(
          {
            location: vscode.ProgressLocation.Notification,
            title: 'Ingesting Slack mentions',
            cancellable: false
          },
          async (progress) => {
            progress.report({ increment: 0, message: 'Searching mentions...' });

            const searchResults = await (global as any).mcp_Slack_slack_search_messages?.({
              query: 'on:me',
              count: limit
            }) || await (vscode as any).mcp?.Slack?.slack_search_messages?.({
              query: 'on:me',
              count: limit
            });

            if (!searchResults) {
              throw new Error('Could not search Slack messages. Ensure Slack MCP is enabled.');
            }

            progress.report({ increment: 50, message: 'Ingesting signals...' });
            
            let ingestedCount = 0;
            const messages = searchResults.messages || searchResults.results || [];
            
            for (const message of messages) {
              const signal: RawSignal = {
                source: 'slack',
                id: message.ts || message.timestamp || Date.now().toString(),
                type: 'mention',
                text: message.text || message.content || '',
                metadata: {
                  channel: message.channel?.name || message.channel_name,
                  channel_id: message.channel?.id || message.channel_id,
                  user: message.user,
                  timestamp: message.ts || message.timestamp
                }
              };

              try {
                await ingestSignal(signal);
                ingestedCount++;
              } catch (error: any) {
                const errorMessage = error?.message || String(error);
                console.warn(`Failed to ingest mention:`, errorMessage);
              }
            }

            progress.report({ increment: 100 });
            
            vscode.window.showInformationMessage(
              `✅ Ingested ${ingestedCount} signals from Slack mentions`
            );
          }
        );
      } catch (error: any) {
        const errorMessage = error?.message || String(error);
        vscode.window.showErrorMessage(`Failed to ingest Slack mentions: ${errorMessage}`);
        console.error('Ingest Slack mentions error:', error);
      }
    }
  );

  // Command: List Slack Channels
  const listChannelsCommand = vscode.commands.registerCommand(
    'pm-intelligence.listSlackChannels',
    async () => {
      try {
        await vscode.window.withProgress(
          {
            location: vscode.ProgressLocation.Notification,
            title: 'Fetching Slack channels',
            cancellable: false
          },
          async (progress) => {
            progress.report({ increment: 0, message: 'Connecting to Slack...' });

            const channelsResponse = await (global as any).mcp_Slack_slack_list_channels?.({
              limit: 200,
              exclude_archived: true
            }) || await (vscode as any).mcp?.Slack?.slack_list_channels?.({
              limit: 200,
              exclude_archived: true
            });

            if (!channelsResponse || !channelsResponse.channels) {
              throw new Error('Could not access Slack channels. Ensure Slack MCP is enabled in Cursor.');
            }

            const channels = channelsResponse.channels;
            const channelNames = channels.map((c: any) => `#${c.name}`).join(', ');
            
            progress.report({ increment: 100 });
            
            // Show in a document
            const doc = await vscode.workspace.openTextDocument({
              content: `# Slack Channels (${channels.length} total)\n\n${channelNames}\n\n## Channel Details\n\n${channels.map((c: any) => `- **#${c.name}** (ID: ${c.id})`).join('\n')}`,
              language: 'markdown'
            });
            await vscode.window.showTextDocument(doc);
            
            vscode.window.showInformationMessage(
              `Found ${channels.length} Slack channels`
            );
          }
        );
      } catch (error: any) {
        const errorMessage = error?.message || String(error);
        vscode.window.showErrorMessage(`Failed to list channels: ${errorMessage}`);
        console.error('List Slack channels error:', error);
      }
    }
  );

  context.subscriptions.push(
    ingestChannelCommand,
    ingestMentionsCommand,
    listChannelsCommand
  );
}
